name: Build and Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    name: Build Release APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make Gradlew executable
        run: chmod +x android/gradlew

      - name: Build Release APK
        working-directory: android
        run: ./gradlew assembleRelease

      - name: Sign APK
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: android/app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"

      - name: Rename APK
        run: |
          VERSION=${{ github.event.inputs.version || github.ref_name }}
          VERSION=${VERSION#v}
          mv ${{ steps.sign_app.outputs.signedReleaseFile }} android/app/build/outputs/apk/release/MindShield-v${VERSION}.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: MindShield-APK
          path: android/app/build/outputs/apk/release/MindShield-*.apk

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: android/app/build/outputs/apk/release/MindShield-*.apk
          generate_release_notes: true
          body: |
            ## üõ°Ô∏è MindShield ${{ github.ref_name }}
            
            ### What's New
            - See the commit history for detailed changes
            
            ### Installation
            1. Download the APK file below
            2. Enable "Install from unknown sources" in your Android settings
            3. Install the APK
            4. Grant Accessibility Service permission
            5. Enable protection and stay focused!
            
            ### Supported Platforms
            - YouTube Shorts
            - Instagram Reels
            - Facebook Reels
            - TikTok
            - Snapchat Spotlight
            - YouTube ReVanced/Vanced
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
